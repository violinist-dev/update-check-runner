shared: &shared
  steps:
    - checkout
    - run:
        name: Install Docker client
        command: apk add --no-cache docker-cli
    - setup_remote_docker:
        version: 19.03.13
    - run: docker build -t update-check-runner . -f Dockerfile-{{ .Environment.PHP_VERSION }}-composer-{{ .Environment.COMPOSER_VERSION }}
    - restore_cache:
        keys:
            - v1-dependencies-{{ checksum "composer.lock" }}-{{ .Environment.CIRCLE_JOB }}
    - run: composer install -n --prefer-dist
    - save_cache:
          key: v1-dependencies-{{ checksum "composer.lock" }}-{{ .Environment.CIRCLE_JOB }}
          paths:
              - ./vendor
    - run: ./vendor/bin/phpunit

jobs:
  "php70":
    environment:
      PHP_VERSION: 70
      COMPOSER_VERSION: 1
    docker:
      - image: violinist/php-base:7.0
    <<: *shared
  "php70-2":
    environment:
      COMPOSER_VERSION: 2
      PHP_VERSION: 70
    docker:
      - image: violinist/php-base:7.0
    <<: *shared
  "php71":
    environment:
      PHP_VERSION: 71
      COMPOSER_VERSION: 1
    docker:
      - image: violinist/php-base:7.1
    <<: *shared
  "php72":
    environment:
      PHP_VERSION: 72
      COMPOSER_VERSION: 1
    docker:
      - image: violinist/php-base:7.2
    <<: *shared
  "php73":
    environment:
      PHP_VERSION: 73
      COMPOSER_VERSION: 1
    docker:
      - image: violinist/php-base:7.3
    <<: *shared

workflows:
  version: 2
  build:
    jobs:
      - "php70"
      - "php70-2"
      - "php71"
      - "php72"
      - "php73"
